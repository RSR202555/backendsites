generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int            @id @default(autoincrement())
  externalId      String         @unique
  email           String         @unique
  name            String?
  role            UserRole       @default(CLIENT)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  subscriptions   Subscription[]
  sites           Site[]
}

model Plan {
  id             Int           @id @default(autoincrement())
  name           String
  priceCents     Int
  description    String?
  periodicity    Periodicity
  siteLimit      Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  subscriptions  Subscription[]
}

model Subscription {
  id                   Int                 @id @default(autoincrement())
  userId               Int
  planId               Int
  status               SubscriptionStatus  @default(PENDING)
  currentPeriodEnd     DateTime
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  user                 User                @relation(fields: [userId], references: [id])
  plan                 Plan                @relation(fields: [planId], references: [id])
  sites                Site[]
  payments             Payment[]
  stripeCustomerId     String?             @unique
  stripeSubscriptionId String?             @unique
  asaasCustomerId      String?
  asaasSubscriptionId  String?
}

model Site {
  id             Int             @id @default(autoincrement())
  userId         Int
  subscriptionId Int?
  url            String          @unique
  status         SiteStatus      @default(ACTIVE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  user           User            @relation(fields: [userId], references: [id])
  subscription   Subscription?   @relation(fields: [subscriptionId], references: [id])
}

model Payment {
  id             Int             @id @default(autoincrement())
  subscriptionId Int
  amountCents    Int
  paidAt         DateTime?
  status         PaymentStatus
  transactionId  String          @unique
  provider       PaymentProvider
  rawPayload     Json?
  createdAt      DateTime        @default(now())

  subscription   Subscription    @relation(fields: [subscriptionId], references: [id])
}

enum UserRole {
  ADMIN
  CLIENT
}

enum Periodicity {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  PENDING
}

enum SiteStatus {
  ACTIVE
  SUSPENDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELED
}

enum PaymentProvider {
  STRIPE
  ASAAS
  MANUAL
}
